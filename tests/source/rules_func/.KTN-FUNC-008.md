# Règle : KTN-FUNC-008 - Commentaires sur Return Statements

## 📋 Description

Tous les return statements en Go doivent avoir un **commentaire explicatif juste au-dessus** qui explique ce qui est retourné et pourquoi.

## 🎯 Objectif

**Pourquoi cette règle existe :**
- **Clarté** : Comprendre immédiatement ce que retourne chaque branche
- **Maintenabilité** : Les commentaires facilitent la compréhension lors des modifications
- **Documentation** : Chaque décision de retour est explicitement documentée
- **Débogage** : Identifier rapidement quel return a été exécuté
- **Revue de code** : Les reviewers comprennent l'intention de chaque return

## ✅ Bonne Pratique (target/)

```go
// MultipleReturnsWithComments a plusieurs returns avec commentaires.
//
// Params:
//   - value: la valeur à vérifier
//
// Returns:
//   - int: la valeur traitée
//   - error: erreur éventuelle
func MultipleReturnsWithComments(value int) (int, error) {
	if value < 0 {
		// Erreur car valeur négative non autorisée
		return 0, errors.New("negative value")
	}

	if value == 0 {
		// Retourne 0 sans erreur pour une valeur nulle
		return 0, nil
	}

	// Retourne le double de la valeur
	return value * 2, nil
}

// SwitchWithReturnComments utilise switch avec commentaires sur returns.
//
// Params:
//   - status: le code de statut
//
// Returns:
//   - string: message correspondant
func SwitchWithReturnComments(status int) string {
	switch status {
	case 200:
		// Retourne "OK" pour un statut HTTP 200
		return "OK"
	case 404:
		// Retourne "Not Found" pour un statut HTTP 404
		return "Not Found"
	case 500:
		// Retourne "Internal Error" pour un statut HTTP 500
		return "Internal Error"
	default:
		// Retourne "Unknown" pour tous les autres statuts
		return "Unknown"
	}
}

// EarlyReturnWithComment fait un early return avec commentaire.
//
// Params:
//   - data: les données à valider
//
// Returns:
//   - error: erreur de validation
func EarlyReturnWithComment(data []string) error {
	if len(data) == 0 {
		// Erreur car les données sont vides
		return errors.New("empty data")
	}

	for _, item := range data {
		if item == "" {
			// Erreur car un élément est vide
			return errors.New("empty item")
		}
	}

	// Succès car toutes les validations sont passées
	return nil
}
```

### Pourquoi c'est bon :
- ✅ **Commentaire juste au-dessus** : Chaque return a son commentaire sur la ligne précédente
- ✅ **Explication claire** : On comprend ce qui est retourné et pourquoi
- ✅ **Tous les returns** : Aucun return n'est oublié (error, success, edge cases)
- ✅ **Cas complexes** : Même les switch/case sont documentés
- ✅ **Early returns** : Les sorties anticipées sont clairement expliquées

## ❌ Mauvaise Pratique (source/)

```go
// ❌ ERREUR: Return simple sans commentaire
func simpleReturnWithoutComment() string {
	return "Hello" // ❌ KTN-FUNC-008: Pas de commentaire au-dessus du return
}

// ❌ ERREUR: Multiple returns sans commentaires
func multipleReturnsNoComments(value int) (int, error) {
	if value < 0 {
		return 0, errors.New("negative value") // ❌ Pas de commentaire
	}

	if value == 0 {
		return 0, nil // ❌ Pas de commentaire
	}

	return value * 2, nil // ❌ Pas de commentaire
}

// ❌ ERREUR: Switch sans commentaires sur returns
func switchWithoutReturnComments(status int) string {
	switch status {
	case 200:
		return "OK" // ❌ Pas de commentaire
	case 404:
		return "Not Found" // ❌ Pas de commentaire
	default:
		return "Unknown" // ❌ Pas de commentaire
	}
}

// ❌ ERREUR: Early returns sans commentaires
func earlyReturnWithoutComment(data []string) error {
	if len(data) == 0 {
		return errors.New("empty data") // ❌ Pas de commentaire
	}

	for _, item := range data {
		if item == "" {
			return errors.New("empty item") // ❌ Pas de commentaire
		}
	}

	return nil // ❌ Pas de commentaire
}
```

### Pourquoi c'est mauvais :
- ❌ **Manque de contexte** : On ne sait pas pourquoi ce return est là
- ❌ **Difficile à déboguer** : Impossible de savoir rapidement quel return a été exécuté
- ❌ **Revue de code difficile** : Les reviewers doivent déduire l'intention
- ❌ **Maintenance complexe** : Les futurs développeurs doivent analyser le code
- ❌ **Perte de logique métier** : L'intention derrière chaque return est perdue

## 🔍 Détection du Linter

### Code d'erreur

| Code | Description |
|------|-------------|
| `KTN-FUNC-008` | Return statement sans commentaire explicatif |

### Message d'erreur

```
[KTN-FUNC-008] Return statement sans commentaire explicatif.
Tout return doit avoir un commentaire juste au-dessus expliquant ce qui est retourné.
Exemple:
  // Erreur de traitement
  return err

  // Succès
  return nil
```

### Ce que le linter vérifie :

1. **Tous les returns** : Aucun return ne peut être sans commentaire
2. **Position du commentaire** : Le commentaire doit être sur la ligne juste au-dessus du return
3. **Pas d'exception** : S'applique à tous les types de returns (error, success, valeurs)
4. **Structures complexes** : Switch, if/else imbriqués, early returns, etc.

## 🤖 Prompt IA

Pour qu'une IA comprenne et applique cette règle automatiquement :

```
Tu es un expert Go. Vérifie que TOUS les return statements respectent la règle KTN-FUNC-008 :

RÈGLE OBLIGATOIRE - COMMENTAIRE SUR RETURN :
- CHAQUE return doit avoir un commentaire juste au-dessus
- Le commentaire doit être sur la ligne précédant immédiatement le return
- Format : // Description de ce qui est retourné et pourquoi
- Exemple : // Erreur de validation / // Succès / // Retourne la valeur calculée

DÉTECTION D'ERREURS :
- Si un return n'a pas de commentaire juste au-dessus → ERREUR KTN-FUNC-008

TYPES DE RETURNS À COMMENTER :
1. Return simple : return value
2. Return avec erreur : return nil, err
3. Return dans if/else : tous les returns de toutes les branches
4. Return dans switch : tous les case et default
5. Early return : return anticipé pour validation
6. Return dans boucle : return à l'intérieur d'un for/range

Pour corriger le code :
1. Identifie TOUS les return statements de la fonction
2. Pour CHAQUE return, ajoute un commentaire sur la ligne juste au-dessus
3. Le commentaire doit expliquer CE QUI est retourné et POURQUOI

EXEMPLE PARFAIT :
func Process(value int) error {
    if value < 0 {
        // Erreur car la valeur ne peut pas être négative
        return errors.New("negative value")
    }

    if value == 0 {
        // Succès car une valeur nulle est valide
        return nil
    }

    // Traitement réussi avec la valeur transformée
    return processValue(value)
}

EXEMPLE INCORRECT :
func Process(value int) error {
    if value < 0 {
        return errors.New("negative value") // ❌ Pas de commentaire au-dessus
    }
    return nil // ❌ Pas de commentaire au-dessus
}
```

## 📚 Références

- [Effective Go - Commentary](https://go.dev/doc/effective_go#commentary)
- [Go Code Review Comments](https://github.com/golang/go/wiki/CodeReviewComments)
- [Google Go Style - Documentation](https://google.github.io/styleguide/go/decisions#documentation)

## 🔄 Scénarios de Test

**Principe d'isolation** : "Tout parfait SAUF l'erreur testée"

Chaque cas de test est conçu pour déclencher **UNIQUEMENT** l'erreur KTN-FUNC-008, sans erreurs parasites provenant d'autres règles.

**Résultats actuels** : 27 erreurs détectées

| # | Scénario | Fichier | Ligne | Résultat attendu |
|---|----------|---------|-------|------------------|
| 1 | Return simple sans commentaire | source:10 | 10:2 | ❌ KTN-FUNC-008 |
| 2 | Multiple returns - erreur | source:23 | 23:3 | ❌ KTN-FUNC-008 |
| 3 | Multiple returns - valeur nulle | source:27 | 27:3 | ❌ KTN-FUNC-008 |
| 4 | Multiple returns - cas normal | source:30 | 30:2 | ❌ KTN-FUNC-008 |
| 5 | Conditions complexes - very large | source:44 | 44:4 | ❌ KTN-FUNC-008 |
| 6 | Conditions complexes - large | source:46 | 46:3 | ❌ KTN-FUNC-008 |
| 7 | Conditions complexes - equal | source:50 | 50:3 | ❌ KTN-FUNC-008 |
| 8 | Conditions complexes - small | source:53 | 53:2 | ❌ KTN-FUNC-008 |
| 9 | Switch case 200 | source:66 | 66:3 | ❌ KTN-FUNC-008 |
| 10 | Switch case 404 | source:68 | 68:3 | ❌ KTN-FUNC-008 |
| 11 | Switch case 500 | source:70 | 70:3 | ❌ KTN-FUNC-008 |
| 12 | Switch default | source:72 | 72:3 | ❌ KTN-FUNC-008 |
| 13 | Early return - empty data | source:86 | 86:3 | ❌ KTN-FUNC-008 |
| 14 | Early return - empty item | source:91 | 91:4 | ❌ KTN-FUNC-008 |
| 15 | Early return - success | source:94 | 94:2 | ❌ KTN-FUNC-008 |
| 16 | Nested returns - niveau 3 | source:110 | 110:5 | ❌ KTN-FUNC-008 |
| 17 | Nested returns - niveau 2 | source:112 | 112:4 | ❌ KTN-FUNC-008 |
| 18 | Nested returns - niveau 1 | source:114 | 114:3 | ❌ KTN-FUNC-008 |
| 19 | Nested returns - base | source:116 | 116:2 | ❌ KTN-FUNC-008 |
| 20 | Error handling - negative | source:130 | 130:3 | ❌ KTN-FUNC-008 |
| 21 | Error handling - too large | source:134 | 134:3 | ❌ KTN-FUNC-008 |
| 22 | Error handling - adjusted | source:139 | 139:3 | ❌ KTN-FUNC-008 |
| 23 | Error handling - normal | source:142 | 142:2 | ❌ KTN-FUNC-008 |
| 24 | Boolean logic - active | source:156 | 156:3 | ❌ KTN-FUNC-008 |
| 25 | Boolean logic - pending | source:160 | 160:3 | ❌ KTN-FUNC-008 |
| 26 | Boolean logic - disabled | source:164 | 164:3 | ❌ KTN-FUNC-008 |
| 27 | Boolean logic - inactive | source:167 | 167:2 | ❌ KTN-FUNC-008 |
| ✅ | Code parfait - Tous les returns commentés | target.go | - | ✅ Aucune erreur |

## 💡 Notes

### Exceptions acceptées

**Aucune exception.** Cette règle s'applique à :
- ✅ Tous les returns (valeur simple, multiple, error, nil)
- ✅ Tous les contextes (if, else, switch, for, defer)
- ✅ Toutes les fonctions (exportées ET privées)
- ✅ Tous les types de retour (primitifs, structs, interfaces, pointeurs)

### Cas particuliers

**Defer avec return** : Les returns dans defer doivent aussi être commentés :
```go
func example() (err error) {
	defer func() {
		if r := recover(); r != nil {
			// Erreur récupérée depuis panic
			err = fmt.Errorf("panic: %v", r)
		}
	}()
	// ...
}
```

**Anonymous functions** : Les returns dans les fonctions anonymes suivent la même règle :
```go
func example() {
	fn := func() error {
		// Retourne une erreur de test
		return errors.New("test")
	}
	// ...
}
```

### Bonnes pratiques

**Commentaires descriptifs** :
- ❌ `// return` (trop vague)
- ❌ `// retourne` (juste une traduction)
- ✅ `// Erreur car la validation a échoué`
- ✅ `// Succès après traitement complet`
- ✅ `// Retourne la valeur par défaut car aucune configuration n'est trouvée`

**Position précise** :
```go
// ✅ CORRECT - Commentaire juste au-dessus
if err != nil {
    // Erreur de connexion à la base de données
    return nil, err
}

// ❌ INCORRECT - Commentaire trop loin
if err != nil {
    // Erreur de connexion

    return nil, err  // ❌ Ligne vide entre commentaire et return
}
```

## 🎓 Formation

### Pour les développeurs

Cette règle vous oblige à :
1. **Réfléchir** à chaque décision de return
2. **Documenter** l'intention derrière chaque sortie de fonction
3. **Faciliter** la maintenance et le débogage
4. **Améliorer** la qualité globale du code

### Pour les reviewers

Lors de la revue de code, vérifiez que :
- Tous les returns ont un commentaire explicatif
- Les commentaires expliquent le "pourquoi", pas le "quoi"
- Les commentaires sont précis et utiles
- Aucun return n'est oublié (switch, nested if, etc.)
