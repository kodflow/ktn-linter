# Règle : Fonctions (Natives)

## 📋 Description

Les fonctions natives (non liées à un struct) en Go doivent respecter des standards stricts de **nommage**, **documentation**, **structure** et **complexité**.

**Note** : Ces règles s'appliquent uniquement aux fonctions natives (`func Name(...)`), pas aux méthodes (`func (r Receiver) Method(...)`).

## 🎯 Objectif

**Pourquoi ces règles existent :**
- **Lisibilité** : Code uniforme et prévisible
- **Maintenabilité** : Documentation claire pour tous les développeurs
- **Performance** : Fonctions courtes et peu complexes
- **Testabilité** : Fonctions simples = tests simples
- **Standards Go** : Conventions officielles Effective Go et Google Go Style Guide
- **Qualité** : Limite stricte de complexité (< 10) et longueur (< 35 lignes)

## ✅ Bonne Pratique (functions.go - target)

```go
// ProcessData traite les données fournies et retourne une erreur si échec
func ProcessData(data string) error {
	if data == "" {
		return errors.New("data vide")
	}
	return nil
}

// FetchUserData récupère les données utilisateur depuis une source externe
// Retourne une erreur si l'utilisateur n'existe pas ou si le contexte expire
func FetchUserData(ctx context.Context, userID int) (string, error) {
	select {
	case <-ctx.Done():
		return "", ctx.Err()
	default:
		if userID <= 0 {
			return "", errors.New("userID invalide")
		}
		return "user data", nil
	}
}

// calculateTotal est une fonction privée bien documentée
// Elle calcule le total en additionnant les valeurs
func calculateTotal(values []int) int {
	total := 0
	for _, v := range values {
		total += v
	}
	return total
}
```

### Pourquoi c'est bon :
- ✅ **Noms en MixedCaps/mixedCaps** : ProcessData, FetchUserData, calculateTotal
- ✅ **Commentaire godoc** : TOUTES les fonctions documentées (exportées ET privées)
- ✅ **Params documentés** : Si > 2 paramètres, mentionnés dans la doc
- ✅ **Returns documentés** : "Retourne une erreur si..."
- ✅ **≤ 5 paramètres** : Respecté partout
- ✅ **< 35 lignes** : Fonctions courtes et focalisées
- ✅ **< 10 complexité** : Logique simple sans imbrications profondes

## ❌ Mauvaise Pratique (functions.go - source)

```go
// ❌ ERREUR 1: snake_case interdit
func parse_http_request(data string) error {
	return nil
}

// ❌ ERREUR 2: Fonction exportée sans commentaire godoc
func ProcessOrder(orderID int) error {
	return nil
}

// ❌ ERREUR 3: Paramètres non documentés dans godoc
// CreateUser crée un nouvel utilisateur
// Retourne l'ID du nouvel utilisateur ou une erreur
func CreateUser(name string, email string, age int) (int, error) {
	return 1, nil
}

// ❌ ERREUR 4: Retours non documentés
// FetchUserData récupère les données utilisateur depuis une source externe
func FetchUserData(ctx context.Context, userID int) (string, error) {
	return "data", nil
}

// ❌ ERREUR 5: Trop de paramètres (6 > 5)
func CreateUserAccount(name string, email string, age int, address string, phone string, active bool) (int, error) {
	return 1, nil
}

// ❌ ERREUR 6: Fonction trop longue (> 35 lignes)
func ProcessLargeOrder(ctx context.Context, orderID int) error {
	// ... 41 lignes de code ...
	return nil
}

// ❌ ERREUR 7: Complexité trop élevée (>= 10)
func ValidateComplexInput(input string, level int) error {
	// ... 16 points de décision ...
	return nil
}
```

### Pourquoi c'est mauvais :
- ❌ **snake_case** : Viole les conventions Go
- ❌ **Pas de godoc** : Impossible de générer documentation automatique
- ❌ **Params non documentés** : Ambiguïté sur le rôle des paramètres
- ❌ **Returns non documentés** : Pas clair ce qui est retourné
- ❌ **Trop de params** : Difficile à tester et maintenir
- ❌ **Fonction trop longue** : Difficile à comprendre en un coup d'œil
- ❌ **Complexité élevée** : Nombreux chemins d'exécution = bugs potentiels

## 🔍 Détection du Linter

### Codes d'erreur

| Code | Description |
|------|-------------|
| `KTN-FUNC-001` | Nom pas en MixedCaps/mixedCaps (snake_case interdit) |
| `KTN-FUNC-002` | Fonction sans commentaire godoc (exportée ET privée) |
| `KTN-FUNC-003` | Commentaire godoc incomplet - paramètres non documentés |
| `KTN-FUNC-004` | Commentaire godoc incomplet - valeurs de retour non documentées |
| `KTN-FUNC-005` | Trop de paramètres (> 5) |
| `KTN-FUNC-006` | Fonction trop longue (> 35 lignes) |
| `KTN-FUNC-007` | Complexité cyclomatique trop élevée (≥ 10) |

### Messages d'erreur détaillés

**KTN-FUNC-001** :
```
Fonction 'parse_http_request' n'utilise pas la convention MixedCaps.
Utilisez MixedCaps pour les fonctions exportées ou mixedCaps pour les privées.
Exemple: calculateTotal au lieu de calculate_total
```

**KTN-FUNC-002** :
```
Fonction 'ProcessOrder' sans commentaire godoc.
Toute fonction doit avoir un commentaire godoc.
Exemple:
  // ProcessOrder traite une commande...
  func ProcessOrder(...) { }
```

**KTN-FUNC-003** :
```
Commentaire godoc de 'CreateUser' ne documente pas les paramètres: name, email, age.
Documentez chaque paramètre pour clarifier leur rôle.
```

**KTN-FUNC-004** :
```
Commentaire godoc de 'FetchUserData' ne documente pas les valeurs de retour.
Documentez ce que retourne la fonction et dans quels cas.
```

**KTN-FUNC-005** :
```
Fonction 'CreateUserAccount' a trop de paramètres (6 > 5).
Limitez à 5 paramètres maximum. Si nécessaire, utilisez une struct de configuration.
Exemple:
  type CreateUserAccountConfig struct { ... }
  func CreateUserAccount(cfg CreateUserAccountConfig) { }
```

**KTN-FUNC-006** :
```
Fonction 'ProcessLargeOrder' est trop longue (41 lignes > 35).
Limitez les fonctions à 35 lignes maximum. Découpez en fonctions plus petites.
```

**KTN-FUNC-007** :
```
Fonction 'ValidateComplexInput' a une complexité cyclomatique trop élevée (16 >= 10).
Réduisez la complexité en extrayant des sous-fonctions ou en simplifiant la logique.
```

### Ce que le linter vérifie :

1. **Nommage** : MixedCaps/mixedCaps obligatoire (KTN-FUNC-001)
2. **Documentation** : Godoc obligatoire pour TOUTES les fonctions (exportées ET privées) (KTN-FUNC-002)
3. **Params documentés** : Si > 2 paramètres, les mentionner dans godoc (KTN-FUNC-003)
4. **Returns documentés** : Si > 1 retour ou retours nommés, les documenter (KTN-FUNC-004)
5. **Limite params** : Maximum 5 paramètres (KTN-FUNC-005)
6. **Longueur** : Maximum 35 lignes de code (KTN-FUNC-006)
7. **Complexité** : Complexité cyclomatique < 10 (KTN-FUNC-007)

## 🔄 Scénarios de Test

**Principe d'isolation** : "Tout parfait SAUF l'erreur testée"

Chaque cas de test est conçu pour déclencher **UNIQUEMENT** l'erreur spécifique testée, sans erreurs parasites provenant d'autres règles. Cette isolation garantit que les tests sont précis et fiables.

**Résultats actuels** : 9 erreurs isolées détectées
- KTN-FUNC-001 : 2 erreurs (noms en snake_case)
- KTN-FUNC-002 : 2 erreurs (fonctions exportées sans godoc)
- KTN-FUNC-003 : 1 erreur (params non documentés)
- KTN-FUNC-004 : 1 erreur (returns non documentés)
- KTN-FUNC-005 : 1 erreur (trop de paramètres)
- KTN-FUNC-006 : 1 erreur (fonction trop longue)
- KTN-FUNC-007 : 1 erreur (complexité trop élevée)

| # | Scénario | Fonction | Résultat attendu |
|---|----------|----------|------------------|
| 1 | Nom en snake_case | parse_http_request | ❌ KTN-FUNC-001 |
| 2 | Nom en Snake_Case mixte | Calculate_Total | ❌ KTN-FUNC-001 |
| 3 | Fonction exportée sans godoc | ProcessOrder | ❌ KTN-FUNC-002 |
| 4 | Autre fonction sans godoc | ValidateEmail | ❌ KTN-FUNC-002 |
| 5 | Params non documentés (> 2) | CreateUser | ❌ KTN-FUNC-003 |
| 6 | Returns non documentés (> 1) | FetchUserData | ❌ KTN-FUNC-004 |
| 7 | 6 paramètres (> 5) | CreateUserAccount | ❌ KTN-FUNC-005 |
| 8 | 41 lignes (> 35) | ProcessLargeOrder | ❌ KTN-FUNC-006 |
| 9 | Complexité 16 (>= 10) | ValidateComplexInput | ❌ KTN-FUNC-007 |
| ✅ | Code parfait - Toutes les règles | target/functions.go | ✅ Aucune erreur |

## 💡 Notes

### Standards stricts

Ces règles sont **plus strictes** que les recommandations Go standard :
- **35 lignes max** (vs 50-80 habituellement)
- **Complexité < 10** (vs 15-20 habituellement)
- **Documentation params obligatoire** si > 2 params

### Complexité cyclomatique

La complexité cyclomatique mesure le nombre de chemins d'exécution :
```go
// Complexité = 1 (base)
func Simple() error {
	return nil
}

// Complexité = 2 (1 base + 1 if)
func WithIf(x int) error {
	if x > 0 {  // +1
		return nil
	}
	return nil
}

// Complexité = 10 (1 base + 9 points de décision)
func Complex(x int) error {
	if x > 0 {      // +1
		if x < 10 { // +1
			for i := 0; i < x; i++ {  // +1
				if i%2 == 0 {          // +1
					// ...
				}
			}
		}
	} else if x < 0 {  // +1
		// ...
	}
	switch x {  // 0 (switch lui-même)
	case 1:     // +1
	case 2:     // +1
	case 3:     // +1
	default:    // 0 (default ne compte pas)
	}
	return nil
}
```

### Documentation minimale

Pour les fonctions avec ≤ 2 paramètres et 1 retour, une documentation simple suffit :
```go
// ✅ OK : simple et clair
// ProcessData traite les données fournies
func ProcessData(data string) error
```

Pour les fonctions avec > 2 paramètres ou > 1 retour, documenter en détail :
```go
// ✅ Documentation complète requise
// CreateUser crée un nouvel utilisateur avec validation
// Les paramètres ctx, name, email, age et active contrôlent la création
// Retourne l'ID du nouvel utilisateur ou une erreur si validation échoue
func CreateUser(ctx context.Context, name string, email string, age int, active bool) (int, error)
```

## 📚 Références

- [Effective Go - Functions](https://go.dev/doc/effective_go#functions)
- [Effective Go - Commentary](https://go.dev/doc/effective_go#commentary)
- [Go Code Review Comments - Function Names](https://github.com/golang/go/wiki/CodeReviewComments#named-result-parameters)
- [Google Go Style Guide - Decisions](https://google.github.io/styleguide/go/decisions)
- [Cyclomatic Complexity](https://en.wikipedia.org/wiki/Cyclomatic_complexity)
